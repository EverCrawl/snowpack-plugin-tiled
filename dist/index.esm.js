import t from"fs/promises";import e from"path";import{JSDOM as i}from"jsdom";const o=new(new i("").window.DOMParser);async function r({filePath:e}){const i=await t.readFile(e,"utf-8"),r=o.parseFromString(i,"text/xml");let l;return!function(t){for(let e=0;e<t.children.length;++e){const i=t.children[e];if("map"===i.tagName&&null!=i.attributes.getNamedItem("tiledversion"))return!0}return!1}(r)?function(t){for(let e=0;e<t.children.length;++e){const i=t.children[e];if("tileset"===i.tagName&&null!=i.attributes.getNamedItem("tiledversion"))return!0}return!1}(r)&&(l={".amt":JSON.stringify(u(e,r,["collision"]))}):l={".amt":JSON.stringify(await a(e,r))},l}const l=Object.freeze({0:"None",1:"Full",2:"Ladder",3:"Platform",4:"SlopeLeft",5:"SlopeRight",6:"SlopeLeftBottom",7:"SlopeRightBottom",8:"SlopeLeftTop",9:"SlopeRightTop",None:0,Full:1,Ladder:2,Platform:3,SlopeLeft:4,SlopeRight:5,SlopeLeftBottom:6,SlopeRightBottom:7,SlopeLeftTop:8,SlopeRightTop:9});async function n(e){return u(e,o.parseFromString(await t.readFile(e,"utf-8"),"text/xml"))}async function s(i,r){const l=i.getAttribute("template");let n;null!=l&&(n=await async function(e){const i=o.parseFromString(await t.readFile(e,"utf-8"),"text/xml").getElementsByTagName("template")[0].getElementsByTagName("object")[0],r=g(i);return{type:i.getAttribute("type"),width:parseFloat(i.getAttribute("width"))??void 0,height:parseFloat(i.getAttribute("height"))??void 0,props:Object.keys(r??{}).length>0?r:void 0}}(e.join(r,l)));const s={...n?.props??{},...g(i)??{}},a=i.getAttribute("width")??n?.width??null,p=i.getAttribute("height")??n?.height??null;let u;if(null!=(u=i.querySelector("ellipse"))){return{base:"ellipse",type:n?.type??void 0,id:parseInt(i.getAttribute("id")),x:parseFloat(i.getAttribute("x")),y:parseFloat(i.getAttribute("y")),width:a,height:p,props:Object.keys(s).length>0?s:void 0}}if(null!=(u=i.querySelector("point"))){return{base:"point",type:n?.type??void 0,id:parseInt(i.getAttribute("id")),x:parseFloat(i.getAttribute("x")),y:parseFloat(i.getAttribute("y")),props:Object.keys(s).length>0?s:void 0}}if(null!=(u=i.querySelector("polygon"))){const t=parseFloat(i.getAttribute("x")),e=parseFloat(i.getAttribute("y")),o=[];for(const i of u.getAttribute("points").split(" ")){const r=i.indexOf(","),l=parseFloat(i.substr(0,r)),n=parseFloat(i.substr(r+1));o.push([t+l,e+n])}return{base:"polygon",type:n?.type??void 0,id:parseInt(i.getAttribute("id")),x:t,y:e,points:o,props:Object.keys(s).length>0?s:void 0}}if(null!=(u=i.querySelector("polyline"))){const t=parseFloat(i.getAttribute("x")),e=parseFloat(i.getAttribute("y")),o=[];for(const i of u.getAttribute("points").split(" ")){const r=i.indexOf(","),l=parseFloat(i.substr(0,r)),n=parseFloat(i.substr(r+1));o.push([t+l,e+n])}return{base:"polyline",type:n?.type??void 0,id:parseInt(i.getAttribute("id")),x:t,y:e,points:o,props:Object.keys(s).length>0?s:void 0}}if(null!=(u=i.querySelector("text"))){return{base:"text",type:n?.type??void 0,id:parseInt(i.getAttribute("id")),x:parseFloat(i.getAttribute("x")),y:parseFloat(i.getAttribute("y")),width:a,height:p,text:{size:u.getAttribute("pixelsize"),wrap:1===parseInt(u.getAttribute("wrap")),content:u.textContent},props:Object.keys(s).length>0?s:void 0}}{const t={type:n?.type??void 0,id:parseInt(i.getAttribute("id")),x:parseFloat(i.getAttribute("x")),y:parseFloat(i.getAttribute("y")),width:a,height:p,props:Object.keys(s).length>0?s:void 0},e=i.getAttribute("gid");return null!=e?(t.base="tile",t.tileId=e):t.base="rect",t}}async function a(t,i){const o=i.getElementsByTagName("map")[0],r={width:parseFloat(o.getAttribute("width")),height:parseFloat(o.getAttribute("height")),background:o.getAttribute("backgroundcolor"),tilesets:[],collision:[],tile:[],object:{}};let a=0;for(const t of o.getElementsByTagName("tileset")){const e=a++;r.tilesets[e]={id:e,firstgid:parseFloat(t.getAttribute("firstgid")),path:t.getAttribute("source")}}0===r.tilesets.length&&console.warn("");let g=[];for(const i of r.tilesets)g.push({id:i.id,firstgid:i.firstgid,data:await n(e.join(e.dirname(t),i.path.replace(".tsx",".xml")))});g=g.sort(((t,e)=>t.firstgid-e.firstgid)).reverse();const p=[...o.getElementsByTagName("group")[0].getElementsByTagName("layer")].sort(((t,e)=>parseFloat(t.getAttribute("name"))-parseFloat(e.getAttribute("name"))));for(let e=0;e<p.length;++e){const i=p[e].getElementsByTagName("data")[0].textContent.replace(/\s+/g,"").split(",");for(let o=0;o<i.length/r.width;++o)for(let n=0;n<i.length/r.height;++n){const s=n+o*r.width;let a,p,u=parseFloat(i[s]);if(u&=536870911,0===u)null==r.collision[s]&&(r.collision[s]=l.None),a=0,p=0;else{const i=g.find((t=>t.firstgid<=u));if(null==i)throw new Error(`[File '${t}'] Could not find tileset for layer#${e}, expected tileset.firstgid < ${u}`);const o=i.data.tiles[u-i.firstgid];if(null!=o.props?.collision){const t=l[o.props.collision];if(null==t)throw new Error(`Invalid CollisionKind ${o.props.collision}`);r.collision[s]=t}else null==r.collision[s]&&(r.collision[s]=l.None);a=i.id,p=u-i.firstgid+1}null==r.tile[e]&&(r.tile[e]=[]),r.tile[e][s]=a<<10>>>0|p<<0>>>0}}for(const i of o.getElementsByTagName("objectgroup")[0].getElementsByTagName("object")){const o=i.getAttribute("name");if(null==o)throw new Error(`[${t}] Object#${i.getAttribute("id")} is missing 'name'`);if(null!=r.object[o])throw new Error(`[${t}] Duplicate object name ${o}`);if(r.object[o]=await s(i,e.dirname(t)),"tile"===r.object[o].base){const e=g.find((t=>t.firstgid<=r.object[o].tileId));if(null==e)throw new Error(`[File '${t}'] Could not find tileset for entity '${o}', expected tileset.firstgid < ${r.object[o].gid}`);const i=e.id,l=r.object[o].tileId-e.firstgid;r.object[o].tileId=i<<10>>>0|l<<0>>>0}}for(let t=0;t<r.tilesets.length;++t)r.tilesets[t]=r.tilesets[t].path.replace(".xml",".amt");return r}function g(t,e=[]){const i=t.getElementsByTagName("properties")[0];if(null==i)return null;const o={};for(const t of i.getElementsByTagName("property")){const i=t.getAttribute("name");e.includes(i)||(o[t.getAttribute("name")]=t.getAttribute("value"))}return 0===Object.keys(o).length?null:o}function p(t){const e=t.getElementsByTagName("animation")[0];if(null==e)return null;const i=[];for(const t of e.getElementsByTagName("frame")){const e=parseInt(t.getAttribute("tileid"));i.push(e)}return i}function u(t,e,i=[]){const o=e.getElementsByTagName("tileset")[0],r=o.getElementsByTagName("image")[0].getAttribute("source"),l={};for(const t of o.getElementsByTagName("tile")){const e={},o=p(t);null!=o&&(e.anim=o);const r=g(t,i);null!=r&&(e.props=r),Object.keys(e).length>0&&(l[parseInt(t.getAttribute("id"))]=e)}return{image:r,tiles:l}}function c(){return{name:"snowpack-plugin-tiled",resolve:{input:[".xml"],output:[".amt"]},load:r}}export default c;
