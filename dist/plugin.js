"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("fs/promises"),e=require("path"),r=require("jsdom");function n(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var l=n(t),i=n(e),o=function(){return(o=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var l in e=arguments[r])Object.prototype.hasOwnProperty.call(e,l)&&(t[l]=e[l]);return t}).apply(this,arguments)};function a(t,e,r,n){return new(r||(r=Promise))((function(l,i){function o(t){try{u(n.next(t))}catch(t){i(t)}}function a(t){try{u(n.throw(t))}catch(t){i(t)}}function u(t){var e;t.done?l(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(o,a)}u((n=n.apply(t,e||[])).next())}))}function u(t,e){var r,n,l,i,o={label:0,sent:function(){if(1&l[0])throw l[1];return l[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,n&&(l=2&i[0]?n.return:i[0]?n.throw||((l=n.return)&&l.call(n),0):n.next)&&!(l=l.call(n,i[1])).done)return l;switch(n=0,l&&(i=[2&i[0],l.value]),i[0]){case 0:case 1:l=i;break;case 4:return o.label++,{value:i[1],done:!1};case 5:o.label++,n=i[1],i=[0];continue;case 7:i=o.ops.pop(),o.trys.pop();continue;default:if(!(l=o.trys,(l=l.length>0&&l[l.length-1])||6!==i[0]&&2!==i[0])){o=0;continue}if(3===i[0]&&(!l||i[1]>l[0]&&i[1]<l[3])){o.label=i[1];break}if(6===i[0]&&o.label<l[1]){o.label=l[1],l=i;break}if(l&&o.label<l[2]){o.label=l[2],o.ops.push(i);break}l[2]&&o.ops.pop(),o.trys.pop();continue}i=e.call(t,o)}catch(t){i=[6,t],n=0}finally{r=l=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}}function s(t){var e="function"==typeof Symbol&&Symbol.iterator,r=e&&t[e],n=0;if(r)return r.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}var c=new(new r.JSDOM("").window.DOMParser);function d(t){var e=t.filePath;return a(this,void 0,void 0,(function(){var t,r,n,i,o,a,s;return u(this,(function(u){switch(u.label){case 0:return[4,l.default.readFile(e,"utf-8")];case 1:return t=u.sent(),function(t){for(var e=0;e<t.children.length;++e){var r=t.children[e];if("map"===r.tagName&&null!=r.attributes.getNamedItem("tiledversion"))return!0}return!1}(r=c.parseFromString(t,"text/xml"))?(s={},i=".amt",a=(o=JSON).stringify,[4,h(e,r)]):[3,3];case 2:return s[i]=a.apply(o,[u.sent()]),n=s,[3,4];case 3:(function(t){for(var e=0;e<t.children.length;++e){var r=t.children[e];if("tileset"===r.tagName&&null!=r.attributes.getNamedItem("tiledversion"))return!0}return!1})(r)&&(n={".amt":JSON.stringify(m(e,r,["collision"]))}),u.label=4;case 4:return[2,n]}}))}))}var p=Object.freeze({0:"None",1:"Full",2:"Ladder",3:"Platform",4:"SlopeLeft",5:"SlopeRight",6:"SlopeLeftBottom",7:"SlopeRightBottom",8:"SlopeLeftTop",9:"SlopeRightTop",None:0,Full:1,Ladder:2,Platform:3,SlopeLeft:4,SlopeRight:5,SlopeLeftBottom:6,SlopeRightBottom:7,SlopeLeftTop:8,SlopeRightTop:9});function f(t){var e,r;return a(this,void 0,void 0,(function(){var n,i,o,a,s,d;return u(this,(function(u){switch(u.label){case 0:return o=(i=c).parseFromString,[4,l.default.readFile(t,"utf-8")];case 1:return n=o.apply(i,[u.sent(),"text/xml"]),a=n.getElementsByTagName("template")[0],s=a.getElementsByTagName("object")[0],d=v(s),[2,{type:s.getAttribute("type"),width:null!==(e=parseFloat(s.getAttribute("width")))&&void 0!==e?e:void 0,height:null!==(r=parseFloat(s.getAttribute("height")))&&void 0!==r?r:void 0,props:Object.keys(null!=d?d:{}).length>0?d:void 0}]}}))}))}function g(t){return a(this,void 0,void 0,(function(){var e,r,n,i;return u(this,(function(o){switch(o.label){case 0:return e=m,r=[t],i=(n=c).parseFromString,[4,l.default.readFile(t,"utf-8")];case 1:return[2,e.apply(void 0,r.concat([i.apply(n,[o.sent(),"text/xml"])]))]}}))}))}function y(t,e){var r,n,l,c,d,p,g,y,h,b,m,w;return a(this,void 0,void 0,(function(){var a,x,A,F,j,S,N,E,O,T,B,k,I,q,L,P,R,C,z,D,J,M,_;return u(this,(function(u){switch(u.label){case 0:return null==(a=t.getAttribute("template"))?[3,2]:[4,f(i.default.join(e,a))];case 1:x=u.sent(),u.label=2;case 2:if(A=o(o({},null!==(r=null==x?void 0:x.props)&&void 0!==r?r:{}),null!==(n=v(t))&&void 0!==n?n:{}),F=null!==(c=null!==(l=t.getAttribute("width"))&&void 0!==l?l:null==x?void 0:x.width)&&void 0!==c?c:null,j=null!==(p=null!==(d=t.getAttribute("height"))&&void 0!==d?d:null==x?void 0:x.height)&&void 0!==p?p:null,null!=(S=t.querySelector("ellipse")))return[2,C={base:"ellipse",type:null!==(g=null==x?void 0:x.type)&&void 0!==g?g:void 0,id:parseInt(t.getAttribute("id")),x:parseFloat(t.getAttribute("x")),y:parseFloat(t.getAttribute("y")),width:F,height:j,props:Object.keys(A).length>0?A:void 0}];if(null!=(S=t.querySelector("point")))return[2,C={base:"point",type:null!==(y=null==x?void 0:x.type)&&void 0!==y?y:void 0,id:parseInt(t.getAttribute("id")),x:parseFloat(t.getAttribute("x")),y:parseFloat(t.getAttribute("y")),props:Object.keys(A).length>0?A:void 0}];if(null!=(S=t.querySelector("polygon"))){O=parseFloat(t.getAttribute("x")),T=parseFloat(t.getAttribute("y")),B=[];try{for(N=s(S.getAttribute("points").split(" ")),E=N.next();!E.done;E=N.next())q=E.value,L=q.indexOf(","),P=parseFloat(q.substr(0,L)),R=parseFloat(q.substr(L+1)),B.push([O+P,T+R])}catch(t){D={error:t}}finally{try{E&&!E.done&&(J=N.return)&&J.call(N)}finally{if(D)throw D.error}}return[2,C={base:"polygon",type:null!==(h=null==x?void 0:x.type)&&void 0!==h?h:void 0,id:parseInt(t.getAttribute("id")),x:O,y:T,points:B,props:Object.keys(A).length>0?A:void 0}]}if(null!=(S=t.querySelector("polyline"))){O=parseFloat(t.getAttribute("x")),T=parseFloat(t.getAttribute("y")),B=[];try{for(k=s(S.getAttribute("points").split(" ")),I=k.next();!I.done;I=k.next())q=I.value,L=q.indexOf(","),P=parseFloat(q.substr(0,L)),R=parseFloat(q.substr(L+1)),B.push([O+P,T+R])}catch(t){M={error:t}}finally{try{I&&!I.done&&(_=k.return)&&_.call(k)}finally{if(M)throw M.error}}return[2,C={base:"polyline",type:null!==(b=null==x?void 0:x.type)&&void 0!==b?b:void 0,id:parseInt(t.getAttribute("id")),x:O,y:T,points:B,props:Object.keys(A).length>0?A:void 0}]}return null!=(S=t.querySelector("text"))?[2,C={base:"text",type:null!==(m=null==x?void 0:x.type)&&void 0!==m?m:void 0,id:parseInt(t.getAttribute("id")),x:parseFloat(t.getAttribute("x")),y:parseFloat(t.getAttribute("y")),width:F,height:j,text:{size:S.getAttribute("pixelsize"),wrap:1===parseInt(S.getAttribute("wrap")),content:S.textContent},props:Object.keys(A).length>0?A:void 0}]:(C={type:null!==(w=null==x?void 0:x.type)&&void 0!==w?w:void 0,id:parseInt(t.getAttribute("id")),x:parseFloat(t.getAttribute("x")),y:parseFloat(t.getAttribute("y")),width:F,height:j,props:Object.keys(A).length>0?A:void 0},null!=(z=t.getAttribute("gid"))?(C.base="tile",C.tileId=z):C.base="rect",[2,C])}}))}))}function h(t,e){var r;return a(this,void 0,void 0,(function(){var n,l,o,a,c,d,f,h,v,b,m,w,x,A,F,j,S,N,E,O,T,B,k,I,q,L,P,R,C,z,D,J,M,_;return u(this,(function(G){switch(G.label){case 0:n=e.getElementsByTagName("map")[0],l={width:parseFloat(n.getAttribute("width")),height:parseFloat(n.getAttribute("height")),background:n.getAttribute("backgroundcolor"),tilesets:[],collision:[],tile:[],object:{}},o=0;try{for(a=s(n.getElementsByTagName("tileset")),c=a.next();!c.done;c=a.next())d=c.value,f=o++,l.tilesets[f]={id:f,firstgid:parseFloat(d.getAttribute("firstgid")),path:d.getAttribute("source")}}catch(t){R={error:t}}finally{try{c&&!c.done&&(C=a.return)&&C.call(a)}finally{if(R)throw R.error}}0===l.tilesets.length&&console.warn(""),h=[],G.label=1;case 1:G.trys.push([1,6,7,8]),v=s(l.tilesets),b=v.next(),G.label=2;case 2:return b.done?[3,5]:(m=b.value,x=(w=h).push,J={id:m.id,firstgid:m.firstgid},[4,g(i.default.join(i.default.dirname(t),m.path.replace(".tsx",".xml")))]);case 3:x.apply(w,[(J.data=G.sent(),J)]),G.label=4;case 4:return b=v.next(),[3,2];case 5:return[3,8];case 6:return A=G.sent(),z={error:A},[3,8];case 7:try{b&&!b.done&&(D=v.return)&&D.call(v)}finally{if(z)throw z.error}return[7];case 8:for(h=h.sort((function(t,e){return t.firstgid-e.firstgid})).reverse(),F=function(t,e){for(var r=0,n=e.length,l=t.length;r<n;r++,l++)t[l]=e[r];return t}([],function(t,e){var r="function"==typeof Symbol&&t[Symbol.iterator];if(!r)return t;var n,l,i=r.call(t),o=[];try{for(;(void 0===e||e-- >0)&&!(n=i.next()).done;)o.push(n.value)}catch(t){l={error:t}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(l)throw l.error}}return o}(n.getElementsByTagName("group")[0].getElementsByTagName("layer"))).sort((function(t,e){return parseFloat(t.getAttribute("name"))-parseFloat(e.getAttribute("name"))})),j=0;j<F.length;++j)for(S=F[j],N=S.getElementsByTagName("data")[0].textContent.replace(/\s+/g,"").split(","),E=0;E<N.length/l.width;++E)for(O=function(e){var n=e+E*l.width,i=parseFloat(N[n]),o=void 0,a=void 0;if(0===(i&=536870911))null==l.collision[n]&&(l.collision[n]=p.None),o=0,a=0;else{var u=h.find((function(t){return t.firstgid<=i}));if(null==u)throw new Error("[File '"+t+"'] Could not find tileset for layer#"+j+", expected tileset.firstgid < "+i);var s=u.data.tiles[i-u.firstgid];if(null!=(null===(r=s.props)||void 0===r?void 0:r.collision)){var c=p[s.props.collision];if(null==c)throw new Error("Invalid CollisionKind "+s.props.collision);l.collision[n]=c}else null==l.collision[n]&&(l.collision[n]=p.None);o=u.id,a=i-u.firstgid+1}null==l.tile[j]&&(l.tile[j]=[]),l.tile[j][n]=o<<10>>>0|a<<0>>>0},T=0;T<N.length/l.height;++T)O(T);B=function(e){var r,n,o,a,s,c;return u(this,(function(u){switch(u.label){case 0:if(null==(r=e.getAttribute("name")))throw new Error("["+t+"] Object#"+e.getAttribute("id")+" is missing 'name'");if(null!=l.object[r])throw new Error("["+t+"] Duplicate object name "+r);return n=l.object,o=r,[4,y(e,i.default.dirname(t))];case 1:if(n[o]=u.sent(),"tile"===l.object[r].base){if(null==(a=h.find((function(t){return t.firstgid<=l.object[r].tileId}))))throw new Error("[File '"+t+"'] Could not find tileset for entity '"+r+"', expected tileset.firstgid < "+l.object[r].gid);s=a.id,c=l.object[r].tileId-a.firstgid,l.object[r].tileId=s<<10>>>0|c<<0>>>0}return[2]}}))},G.label=9;case 9:G.trys.push([9,14,15,16]),k=s(n.getElementsByTagName("objectgroup")[0].getElementsByTagName("object")),I=k.next(),G.label=10;case 10:return I.done?[3,13]:(q=I.value,[5,B(q)]);case 11:G.sent(),G.label=12;case 12:return I=k.next(),[3,10];case 13:return[3,16];case 14:return L=G.sent(),M={error:L},[3,16];case 15:try{I&&!I.done&&(_=k.return)&&_.call(k)}finally{if(M)throw M.error}return[7];case 16:for(P=0;P<l.tilesets.length;++P)l.tilesets[P]=l.tilesets[P].path.replace(".xml",".amt");return[2,l]}}))}))}function v(t,e){var r,n;void 0===e&&(e=[]);var l=t.getElementsByTagName("properties")[0];if(null==l)return null;var i={};try{for(var o=s(l.getElementsByTagName("property")),a=o.next();!a.done;a=o.next()){var u=a.value,c=u.getAttribute("name");e.includes(c)||(i[u.getAttribute("name")]=u.getAttribute("value"))}}catch(t){r={error:t}}finally{try{a&&!a.done&&(n=o.return)&&n.call(o)}finally{if(r)throw r.error}}return 0===Object.keys(i).length?null:i}function b(t){var e,r,n=t.getElementsByTagName("animation")[0];if(null==n)return null;var l=[];try{for(var i=s(n.getElementsByTagName("frame")),o=i.next();!o.done;o=i.next()){var a=o.value,u=parseInt(a.getAttribute("tileid"));l.push(u)}}catch(t){e={error:t}}finally{try{o&&!o.done&&(r=i.return)&&r.call(i)}finally{if(e)throw e.error}}return l}function m(t,e,r){var n,l;void 0===r&&(r=[]);var i=e.getElementsByTagName("tileset")[0],o=i.getElementsByTagName("image")[0].getAttribute("source"),a={};try{for(var u=s(i.getElementsByTagName("tile")),c=u.next();!c.done;c=u.next()){var d=c.value,p={},f=b(d);null!=f&&(p.anim=f);var g=v(d,r);null!=g&&(p.props=g),Object.keys(p).length>0&&(a[parseInt(d.getAttribute("id"))]=p)}}catch(t){n={error:t}}finally{try{c&&!c.done&&(l=u.return)&&l.call(u)}finally{if(n)throw n.error}}return{image:o,tiles:a}}exports.default=function(){return{name:"snowpack-plugin-tiled",resolve:{input:[".xml"],output:[".amt"]},load:d}};
